# openbmc-stm32mpu

This repository aims to bring STM32MPU support into [OpenBMC project](https://github.com/openbmc/openbmc).

The *meta-st* is based on [*OpenSTLinux* distribution](https://wiki.st.com/stm32mpu/wiki/OpenSTLinux_distribution).

## Version

|                   | Version                                                       |
| --------          | -------                                                       |
| **Yocto**         | Mickledore                                                    |
| **OpenSTLinux**   | 5.1.0                                                         |
| **OpenBMC**       | 2.14.0 (SHA1 : *1e488cdf844bf4aa82d3c90875a56fb35c7f210d*)    |

## How to set up openBMC for STM32MPU ?

### Clone the openBMC project

The first step to do is to clone [openBMC community project](https://github.com/openbmc/openbmc) from the official GitHub repository.
We need to point on the SHA1 mentioned in the table above.

```sh
git clone https://github.com/openbmc/openbmc.git
cd openbmc
git checkout 1e488cdf844bf4aa82d3c90875a56fb35c7f210d
```

You can check all the supported platforms by doing the following command :

```sh
. setup
```

It will display all the different MACHINE you can source with Yocto. You can also see that there is no STMicroelectronics SoC/boards present, we will so add them thanks to this repo.

### Get the *meta-st* layer and add it to openbmc

This step is quite simple, we will simply clone this current repository into a temporary folder, then copy *meta-st* into openbmc repo that we cloned before.
We will call :
* **<folder_openbmc>** the directory in which openbmc project is located.
* **<folder_st>** the directory in which you cloned this repo.

```sh
mkdir <folder_st>
cd <folder_st>
git clone https://github.com/STMicroelectronics/openbmc-stm32mpu.git -b mickledore 
cp -r ./openbmc-stm32mpu/meta-st <folder_openbmc>/openbmc
```

In your **openbmc** repo, you should now see the *meta-st* layer next to all other vendor Yocto layers.

Now if you do 
```sh
. setup
```
You should see ST Yocto MACHINES (.e.g *stm32mp1*, *stm32mp2*, *stm32mp25-eval* ...)

### Source and build openbmc distribution

Depending on the ST image you want to build, you have to use the setup script to source correctly your environment. The parameter you give to *setup* script is one of the MACHINE output by the previous command.

```sh
. setup <ST_MACHINE>
```
Example : 

```sh
. setup stm32mp2
```
You are now ready to build :
```sh
BB_NO_NETWORK="1" bitbake obmc-phosphor-image
```

This Yocto compilation can takes a lot of time, take a break !
When compilation is finished, your final openBMC distribution image is now generated.

### Deploy your final image

To ensure the compatibility with STMicroelectronics tools as CubeProgramer, *meta-st* does not use the default File System generated by *openbmc* distribution project, but keep its native OpenSTLinux recipes to format the TSV files, the FIPs and so on.
You can go in the correponding build folders to get all the files generated :

```sh
cd tmp/deploy/images/<machine>/
```

The way to flash your image is so definitly the same as explained in ***OpenSTLinux documentation***. Please refer to the ***Populate the target and boot the image*** article corresponding to your platform : https://wiki.st.com/stm32mpu/wiki/Getting_started

Example for STM32MP257F-EV board : [here](https://wiki.st.com/stm32mpu/wiki/Getting_started/STM32MP2_boards/STM32MP257x-EV1/Let%27s_start/Populate_the_target_and_boot_the_image)

Once the image is flashed, you can boot your board with *openBMC distribution software* running on it.

***Warning : by default, openBMC distribution creates and activate a watchdog that aims to check the alive connection between the Host and the BMC chip. If you do not have an host chip kicking this watchdog for now, your board will restart each time. To avoid this, you can disable the watchdog or just rename it with the following command :***

```sh
mv /lib/systemd/system.conf.d/40-hardware-watchdog.conf /lib/systemd/system.conf.d/40-hardware-watchdog.conf.backup
```

## Disclaimer

The Yocto layer distributed here guarantees only minimal support for STM32MPU platforms within the OpenBMC project. Configuration and interconnection with the host chip and chassis must be done entirely by the user. For further information, please refer to the official OpenBMC project documentation.

## Versioning 

For each release, you can identify the version by the different information below :
* **Branch** : the name of the Yocto version used.
* **Tag ST** : the version of OpenSTLinux used as basis for *meta-st*.
* **Tag OpenBMC** : the version of OpenBMC project release.